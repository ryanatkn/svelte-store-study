function V(s,e){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,n=Object.getOwnPropertySymbols(s);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(s,n[r])&&(t[n[r]]=s[n[r]]);return t}function i(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)}function c(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t}var f,d,S,b,y,_,m,D,T,P,g,x,O;const F=typeof Symbol=="function"&&Symbol.observable||"@@observable",B=s=>"subscribe"in s?s:s[F](),p=()=>{},U=(s,e)=>{const t=s?s[e]:null;return typeof t=="function"?t.bind(s):p},H=s=>typeof s=="function"?{next:s.bind(null),pause:p,resume:p,_value:void 0,_valueIndex:0}:{next:U(s,"next"),pause:U(s,"pause"),resume:U(s,"resume"),_value:void 0,_valueIndex:0},J=function(){return this};function Q(s){return{subscribe:s.subscribe.bind(s),[F]:J}}const E=Symbol(),G=Symbol();let q=!1;const I=new Set,W=s=>typeof s=="function"?s():s.unsubscribe(),K=s=>{const e=!q;e&&(q=!0);try{return s()}finally{if(e){for(const t of I)I.delete(t),t[G]();q=!1}}},k=s=>({[s]:!1,[s-1]:!0,0:!0});class N{constructor(e){f.add(this),d.set(this,new Set),S.set(this,null),b.set(this,!1),y.set(this,1),_.set(this,void 0),m.set(this,k(1)),c(this,_,e,"f")}[(d=new WeakMap,S=new WeakMap,b=new WeakMap,y=new WeakMap,_=new WeakMap,m=new WeakMap,f=new WeakSet,D=function(){c(this,S,this.onUse()||p,"f")},T=function(){const t=i(this,S,"f");t&&(c(this,S,null,"f"),W(t))},G)](){c(this,b,!1,"f");for(const e of[...i(this,d,"f")])e._valueIndex!==0&&i(this,f,"m",g).call(this,e)}notEqual(e,t){return!Object.is(e,t)||e&&typeof e=="object"||typeof e=="function"}pauseSubscribers(){if(!i(this,b,"f")){c(this,b,!0,"f");for(const e of[...i(this,d,"f")])e._valueIndex!==0&&e.pause()}}resumeSubscribers(){i(this,b,"f")&&K(()=>{I.add(this)})}set(e){if(this.notEqual(i(this,_,"f"),e)){const t=i(this,y,"f")+1;c(this,y,t,"f"),c(this,_,e,"f"),c(this,m,k(t),"f"),this.pauseSubscribers()}this.resumeSubscribers()}update(e){this.set(e(i(this,_,"f")))}onUse(){}subscribe(e){const t=H(e);i(this,d,"f").add(t),i(this,d,"f").size==1?i(this,f,"m",D).call(this):i(this,f,"m",P).call(this),i(this,f,"m",g).call(this,t);const n=()=>{const r=i(this,d,"f").delete(t);t.next=p,t.pause=p,t.resume=p,r&&i(this,d,"f").size===0&&i(this,f,"m",T).call(this)};return n[E]=()=>{i(this,f,"m",P).call(this),i(this,f,"m",g).call(this,t)},n.unsubscribe=n,n}[(P=function(){var t,n;(n=(t=i(this,S,"f"))===null||t===void 0?void 0:t[E])===null||n===void 0||n.call(t)},g=function(t){const n=i(this,m,"f"),r=i(this,y,"f"),o=i(this,_,"f");let a=n[t._valueIndex];a==null&&(a=this.notEqual(t._value,o),n[t._valueIndex]=a),t._valueIndex=r,a?(t._value=o,t.next(o),i(this,b,"f")&&t.pause()):i(this,b,"f")||t.resume()},F)](){return this}}const C=()=>{};C.unsubscribe=C;class L extends N{constructor(e){super(e)}set(e){super.set(e)}update(e){super.update(e)}}const R=(s,e)=>{const{onUse:t,notEqual:n}=e;return t&&(s.onUse=function(){const r=o=>this.set(o);return r.set=r,r.update=o=>this.update(o),t(r)}),n&&(s.notEqual=function(r,o){return n(r,o)}),s};function Y(s,e={}){typeof e=="function"&&(e={onUse:e});const t=R(new L(s),e);return Object.assign(Object.assign({},Q(t)),{set:t.set.bind(t),update:t.update.bind(t)})}function X(s){return s.length<=1}class z extends N{constructor(e,t){super(t),x.set(this,void 0),O.set(this,void 0);const n=Array.isArray(e);c(this,x,n,"f"),c(this,O,(n?[...e]:[e]).map(B),"f")}onUse(){let e=!1,t=0,n=0;const r=i(this,x,"f"),o=i(this,O,"f"),a=new Array(o.length);let h=null;const v=()=>{const u=h;u&&(h=null,W(u))},w=(u=!1)=>{u&&(e=!0),e&&(u||!t)&&(n&&(n=0,v(),h=this.derive(r?a:a[0])||p),this.resumeSubscribers())},M=o.map((u,l)=>u.subscribe({next:j=>{a[l]=j,n|=1<<l,t&=~(1<<l),w()},pause:()=>{t|=1<<l,this.pauseSubscribers()},resume:()=>{t&=~(1<<l),w()}}));w(!0);const A=()=>{v(),M.forEach(W)};return A[E]=()=>{var u,l;e=!1;for(const j of M)(l=(u=j)[E])===null||l===void 0||l.call(u);w(!0)},A}}x=new WeakMap,O=new WeakMap;function Z(s,e,t){typeof e=="function"&&(e={derive:e});const{derive:n}=e,r=V(e,["derive"]),o=X(n)?class extends z{derive(a){this.set(n(a))}}:class extends z{derive(a){const h=v=>this.set(v);return h.set=h,h.update=v=>this.update(v),n(a,h)}};return Q(R(new o(s,t),Object.assign(Object.assign({},r),{onUse:void 0})))}export{K as b,Z as d,Y as w};
